<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>

    <style type="text/css">
        .container {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
            font-size: larger;
        }

        .chatContainer {
            width: 98%;
            background-color: #DDDDDD;
            margin: 2px 5px 2px 5px;
            overflow-y: auto;
            height: 200px;
            font-size: larger;
        }
    </style>
</head>
<body>

    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-2.1.1.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.1.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>

    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">

        function isEmpty(obj) {
            if (typeof obj == 'undefined' || obj === null || obj === '') return true;
            if (typeof obj == 'number' && isNaN(obj)) return true;
            if (obj instanceof Date && isNaN(Number(obj))) return true;
            return false;
        }

        $(function () {
            var chatnick;
            $('#name').focus();

            // Declare a proxy to reference the hub.
            var chat = $.connection.chatHub;

            // Declare functions the hub will call here BEFORE you "start" the hub
            //

            // Implement the function the hub will call to broadcast messages
            // note use of <hub>.client to denote this is a function called on
            // the client
            chat.client.broadcastMessage = function (name, message) {
                // Html encode display name and message.
                var encodedName = $('<div />').text(name).html();
                var encodedMsg = $('<div />').text(message).html();

                // Add the message to the page.
                $('#chatMessages').append(encodedName + ': ' + encodedMsg + '<br/>');
                $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
            };

            $.connection.hub.logging = true;


            // Start the connection.
            $.connection.hub.start().done(function () {

                // Using jquery to register these event handlers
                // after the hub connection is established
                $('#joinchat').click(function () {
                    chatnick = $('#name').val();
                    if (isEmpty(chatnick)) {
                        return;
                    }

                    // call the Hub's registerUser method and pass in the chosen chat nickname
                    // the proxy camel cases the method call so javascript developers don't freak out
                    chat.server.registerUser(chatnick);

                    // remove the join button, disable the username field, enable message entry
                    $('#joinchat').fadeOut(1250, null).off('click');
                    $('#name').attr('disabled', true);
                    $('#newMessage').attr('disabled', false);
                    $('#newMessage').focus();
                });

                $('#newMessageContainer').keydown(function (ev) {
                    var key = ev.keyCode || ev.which;
                    switch (key) {
                        case 27:
                            $('#newMessage').val('');
                            break;
                        case 13:
                            if (chatnick) {
                                // get the message entry
                                var newMessage = $('#newMessage').val();

                                // call the hub's Send method
                                chat.server.send(newMessage);

                                $('#newMessage').val('');
                                ev.preventDefault();
                                return false;
                            }
                    }
                });
            });
        });

    </script>

    <div class="container">
        <label for="name">Username:</label>
        <input type="text" id="name" />
        <input type="button" id="joinchat" value="Join" />
        <br />
        <div id="chatMessages" class="chatContainer">
        </div>
        <div id="newMessageContainer">
            <textarea accesskey="m" id="newMessage"
                style="resize: none; width: 98%; height: 20px; background-color: #EEEEEE; margin: 2px 5px 2px 5px;"
                disabled></textarea>
        </div>
    </div>
</body>
</html>